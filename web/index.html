<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>Better audio for BigBlueButton</title>
        <script src="service.js" ></script>
        <script>

// known constants
const kParameter_leveler_target = 13;
const kParameter_mb_strength = 15;

// load the wasm modules
function init(callback) {
    var err = [];

    // check if supported
    if (navigator.mediaDevices === undefined || navigator.mediaDevices.getUserMedia === undefined) {
        err.push('navigator.mediaDevices.getUserMedia unsupported');
    }

    // bail-out early if any errors happened
    if (err.length !== 0) {
        callback(err);
        return;
    }

    loadWasmProcessorFiles().then(function() {
        callback();
    }).catch(function(error) {
        callback([error]);
        return;
    });
};

// custom global vars
let gumStream = null;
let delayNode = null;

function changeAudioConstraints() {
    if (gumStream) {
        // NOTE chrome does not support this
        if (!!window.chrome) {
            enableStream();
            return;
        }
        const constraints = {
            'autoGainControl': { 'ideal': document.getElementById('gum-autoGainControl').checked },
            'echoCancellation': { 'ideal': document.getElementById('gum-echoCancellation').checked },
            'noiseSuppression': { 'ideal': document.getElementById('gum-noiseSuppression').checked },
        };
        console.log("dynamic reapply contraints!", constraints);
        gumStream.getAudioTracks()[0].applyConstraints(constraints);
    }
}

// restart the stream
function enableStream() {
    if (gumStream) {
        gumStream.getTracks().forEach(track => track.stop());
        gumStream = null;
    }

    delayNode = null;

    const constraints = {
        'audio': {
            'autoGainControl': { 'ideal': document.getElementById('gum-autoGainControl').checked },
            'echoCancellation': { 'ideal': document.getElementById('gum-echoCancellation').checked },
            'noiseSuppression': { 'ideal': document.getElementById('gum-noiseSuppression').checked },
            'channelCount': { 'min': 0, 'ideal': 1 },
        },
        'video': false,
    };
    const handleError = function(err) {
        document.getElementById('error').setHTMLUnsafe('<h2>Error</h2><p>' + err + '</p>');
        document.getElementById('error').style.removeProperty('display');
        console.error(err);
    };

    navigator.mediaDevices.getUserMedia(constraints).then(async function(stream) {
        document.getElementById('enable-input').style.setProperty('display', 'none');

        gumStream = stream;

        createWasmProcessorStream(stream).then(function([wasmProcStream, audioProcessor, audioContext]) {
            // initial setup matching live parameters
            console.log("createWasmProcessorStream callback", wasmProcStream, audioProcessor, audioContext);
            setWasmProcessorEnabled(document.getElementById('enable-bbba').checked);
            setWasmProcessorParameter(kParameter_mb_strength, document.getElementById('bbba-strength').value);
            setWasmProcessorParameter(kParameter_leveler_target, document.getElementById('bbba-target').value);

            // create delay node just before the speakers
            const delayOpts = {
                channelCount: 1,
                delayTime: document.getElementById('delay').value,
                maxDelayTime: 1,
            };
            delayNode = new DelayNode(audioContext, delayOpts);

            // connect processor to delay, then to speakers
            audioProcessor.connect(delayNode);
            delayNode.connect(audioContext.destination);

            console.log("createWasmProcessorStream final action done!");
        }).catch(handleError);
    }).catch(handleError);
};

window.addEventListener('DOMContentLoaded', function() {
    // call init function and do setup processing once we have loaded the wasm modules
    init(function(err) {
        if (err) {
            document.getElementById('error').setHTMLUnsafe('<h2>Error</h2><p>' + err.join('<br>') + '</p>');
            return;
        }

        document.getElementById('error').style.setProperty('display', 'none');
        document.getElementById('content').style.removeProperty('display');

        // live parameters
        var elems = {
            strength: document.getElementById('bbba-strength'),
            strengthVal: document.getElementById('bbba-strength-value'),
            target: document.getElementById('bbba-target'),
            targetVal: document.getElementById('bbba-target-value'),
            delay: document.getElementById('delay'),
            delayVal: document.getElementById('delay-value'),
        };
        elems.strengthVal.textContent = elems.strength.value;
        elems.targetVal.textContent = elems.target.value;
        elems.delayVal.textContent = elems.delay.value;

        document.getElementById('gum-autoGainControl').addEventListener('click', changeAudioConstraints);
        document.getElementById('gum-echoCancellation').addEventListener('click', changeAudioConstraints);
        document.getElementById('gum-noiseSuppression').addEventListener('click', changeAudioConstraints);

        document.getElementById('enable-bbba').addEventListener('click', function() {
            setWasmProcessorEnabled(this.checked);
        });

        elems.strength.addEventListener('input', function(event) {
            elems.strengthVal.textContent = event.target.value;
            setWasmProcessorParameter(kParameter_mb_strength, event.target.value);
        });
        elems.target.addEventListener('input', function(event) {
            elems.targetVal.textContent = event.target.value;
            setWasmProcessorParameter(kParameter_leveler_target, event.target.value);
        });
        elems.delay.addEventListener('input', function(event) {
            elems.delayVal.textContent = event.target.value;
            if (delayNode)
                delayNode.delayTime.value = event.target.value;
        });

        document.getElementById('enable-input').addEventListener('click', enableStream);
    });
});

        </script>
        <style>
            table {
                text-align: center;
            }
            td {
                min-width: 40px;
            }
        </style>
    </head>
    <body>
        <div id="error">Loading... (might need mouse click)</div>
        <div id="content" style="display: none">
            <div id="bbba">
                <h2>Better audio for BigBlueButton</h2>
                <div id="main">
                    <input type="button" id="enable-input" value="Start (Enable Input)" />
                </div>
                <br/>
                <fieldset>
                    <legend>Web Browser constraints</legend>
                    <div>
                        <input autocomplete="off" type="checkbox" id="gum-autoGainControl" value="gum-autoGainControl"></input>
                        <label for="gum-autoGainControl">Auto Gain Control</label>
                    </div>
                    <div>
                        <input autocomplete="off" type="checkbox" id="gum-noiseSuppression" value="gum-noiseSuppression"></input>
                        <label for="gum-noiseSuppression">Noise Suppression</label>
                    </div>
                    <div>
                        <input autocomplete="off" type="checkbox" id="gum-echoCancellation" value="gum-echoCancellation"></input>
                        <label for="gum-echoCancellation">Echo Cancellation</label>
                    </div>
                </fieldset>
                <br/>
                <fieldset>
                    <legend>BBBA</legend>
                    <div>
                        <input autocomplete="off" type="checkbox" id="enable-bbba" value="enable-bbba" checked></input>
                        <label for="enable-bbba">Active</label>
                    </div>
                    <table>
                        <tr>
                            <td>Strength:</td>
                            <td><output id="bbba-strength-value"></output></td>
                            <td><input autocomplete="off" id="bbba-strength" type="range" value="100" min="0" max="100" /></td>
                        </tr>
                        <tr>
                            <td>Target Loudness (dB):</td>
                            <td><output id="bbba-target-value"></output></td>
                            <td><input autocomplete="off" id="bbba-target" type="range" value="-22" min="-60" max="0" /></td>
                        </tr>
                    </table>
                </fieldset>
                <br/>
                <fieldset>
                    <legend>Delay</legend>
                    <table>
                        <tr>
                            <td>Amount (s):</td>
                            <td><output id="delay-value"></output></td>
                            <td><input autocomplete="off" id="delay" type="range" value="0.5" min="0" max="1" step="0.1"/></td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
    </body>
</html>
