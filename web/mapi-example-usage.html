<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>Better audio for BigBlueButton</title>
        <script>

// module meta-data, manually extracted from faust files
// { def, min, max }
var Parameters = {
    strength: 0,
    // { 50.0, 0.0, 100.0 },
    spec_0: 1,
    // { -10.0, -20.0, 0.0 },
    spec_1: 2,
    // { -5.0, -20.0, 0.0 },
    spec_2: 3,
    // { -5.0, -20.0, 0.0 },
    spec_3: 4,
    // { -8.0, -20.0, 0.0 },
    spec_4: 5,
    // { -9.0, -20.0, 0.0 },
    spec_5: 6,
    // { -10.0, -20.0, 0.0 },
    spec_6: 7,
    // { -7.0, -20.0, 0.0 },
    spec_7: 8,
    // { -3.0, -20.0, 0.0 },
    bypass: 9,
    // { 0, 0, 1 },
    target: 10,
    // { -23.0, -60.0, 0.0 },
    thresh_offset: 11,
    // { 6.0, 0.0, 40.0 },
    preLowcut_freq: 12,
    // { 80.0, 1.0, 400.0 },
};

// global vars
var audioContext = null;
var audioProcessor = null;

// load the wasm modules
function init(callback) {
    var err = [];

    // check if audio is supported
    if (typeof(AudioContext) !== 'undefined') {
        audioContext = new AudioContext();
    } else {
        err.push('AudioContext unsupported');
    }
    if (navigator.mediaDevices === undefined || navigator.mediaDevices.getUserMedia === undefined) {
        err.push('navigator.mediaDevices.getUserMedia unsupported');
    }

    // check if WebAssembly is properly supported
    if (typeof(WebAssembly) === 'undefined') {
        err.push('WebAssembly unsupported');
    } else {
        if (! WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,2,8,1,1,97,1,98,3,127,1,6,6,1,127,1,65,0,11,7,5,1,1,97,3,1])))
            err.push('Importable/Exportable mutable globals unsupported');
    }

    // bail-out early if any errors happened
    if (err.length !== 0) {
        callback(err);
        return;
    }

    // load mapi files, trigger callback when all done
    var moduleJs = null, moduleWasm = null, workletLoaded = false;

    // load audio worklet
    audioContext.audioWorklet.addModule("mapi-proc.js").then(function() {
        workletLoaded = true;
        if (moduleJs && moduleWasm && workletLoaded) {
            callback(null, moduleJs, moduleWasm);
        }
    }).catch(function(error) {
        err.push(error);
        callback(err);
    });

    // load mapi js
    fetch('BBBA-mapi.js').then(function(resp) {
        resp.text().then(function(text) {
            moduleJs = text;
            if (moduleJs && moduleWasm && workletLoaded) {
                callback(null, moduleJs, moduleWasm);
            }
        }).catch(function(error) {
            err.push(error);
            callback(err);
        });
    }).catch(function(error) {
        err.push(error);
        callback(err);
    });

    // load mapi wasm
    fetch('BBBA-mapi.wasm').then(function(resp) {
        resp.arrayBuffer().then(function(bytes) {
            moduleWasm = bytes;
            if (moduleJs && moduleWasm && workletLoaded) {
                callback(null, moduleJs, moduleWasm);
            }
        }).catch(function(error) {
            err.push(error);
            callback(err);
        });
    }).catch(function(error) {
        err.push(error);
        callback(err);
    });
};

window.addEventListener('DOMContentLoaded', function() {
    // call init function and do setup processing once we have loaded the wasm modules
    init(function(err, moduleJs, moduleWasm) {

        if (err) {
            document.getElementById('error').setHTMLUnsafe('<h2>Error</h2><p>' + err.join('<br>') + '</p>');
            return;
        }

        document.getElementById('error').style.setProperty('display', 'none');
        document.getElementById('content').style.removeProperty('display');

        // audio input processing
        document.getElementById('enable-input').addEventListener('click', function() {
            var numInputs = 1;
            var numOutputs = 1;

            var constraints = {
                'audio': {
                    'autoGainControl': { 'ideal': false },
                    'echoCancellation': { 'ideal': false },
                    'noiseSuppression': { 'ideal': false },
                    'channelCount': { 'min': 0, 'ideal': numInputs },
                    'latency': { 'min': 0, 'ideal': 0 },
                    'sampleSize': { 'min': 8, 'max': 32, 'ideal': 16 },
                    // old properties for chrome
                    'googAudioMirroring': { 'ideal': false },
                    'googAutoGainControl': { 'ideal': false },
                    'googAutoGainControl2': { 'ideal': false },
                    'googDAEchoCancellation': { 'ideal': false },
                    'googEchoCancellation': { 'ideal': false },
                    'googEchoCancellation2': { 'ideal': false },
                    'googHighpassFilter': { 'ideal': false },
                    'googNoiseSuppression': { 'ideal': false },
                    'googNoiseSuppression2': { 'ideal': false },
                    'googTypingNoiseDetection': { 'ideal': false },
                    'intelligibilityEnhancer': { 'ideal': false },
                    'levelControl': { 'ideal': false },
                    'levelControlInitialPeakLevelDBFS': { 'ideal': false },
                },
                'video': false,
            };

            var success = function(stream) {
                document.getElementById('enable-input').style.setProperty('display', 'none');

                audioProcessor = new AudioWorkletNode(audioContext, "mapi-proc", {
                    numberOfInputs: numInputs,
                    numberOfOutputs: numOutputs,
                    // outputChannelCount: [numOutputs, numOutputs],
                });
                audioProcessor.port.postMessage({type: 'init', js: moduleJs, wasm: moduleWasm});

                audioContext.createMediaStreamSource(stream).connect(audioProcessor);
                audioProcessor.connect(audioContext.destination);
            };
            var fail = function(err) {
                document.getElementById('error').setHTMLUnsafe('<h2>Error</h2><p>' + err + '</p>');
                document.getElementById('error').style.removeProperty('display');
                console.error(err);
            };

            navigator.mediaDevices.getUserMedia(constraints).then(success).catch(fail);
        });

        // plugin parameters
        // typically these would be pre-setup to a known good configuration
        var elems = {
            bypass: document.getElementById('bbba-bypass'),
            strength: document.getElementById('bbba-strength'),
            strengthVal: document.getElementById('bbba-strength-value'),
            target: document.getElementById('bbba-target'),
            targetVal: document.getElementById('bbba-target-value'),
            threshOffset: document.getElementById('bbba-thresh-offset'),
            threshOffsetVal: document.getElementById('bbba-thresh-offset-value'),
            preLowcutFreq: document.getElementById('bbba-preLowcut-freq'),
            preLowcutFreqVal: document.getElementById('bbba-preLowcut-freq-value'),
        };
        elems.strengthVal.textContent = elems.strength.value;
        elems.targetVal.textContent = elems.target.value;
        elems.threshOffsetVal.textContent = elems.threshOffset.value;
        elems.preLowcutFreqVal.textContent = elems.preLowcutFreq.value;

        elems.bypass.addEventListener('click', function() {
            audioProcessor.port.postMessage({type: 'param', index: Parameters.bypass, value: this.checked ? 1.0 : 0.0});
        });
        elems.strength.addEventListener('input', function(event) {
            audioProcessor.port.postMessage({type: 'param', index: Parameters.strength, value: event.target.value});
            elems.strengthVal.textContent = event.target.value;
        });
        elems.target.addEventListener('input', function(event) {
            audioProcessor.port.postMessage({type: 'param', index: Parameters.target, value: event.target.value});
            elems.targetVal.textContent = event.target.value;
        });
        elems.threshOffset.addEventListener('input', function(event) {
            audioProcessor.port.postMessage({type: 'param', index: Parameters.thresh_offset, value: event.target.value});
            elems.threshOffsetVal.textContent = event.target.value;
        });
        elems.preLowcutFreq.addEventListener('input', function(event) {
            audioProcessor.port.postMessage({type: 'param', index: Parameters.preLowcut_freq, value: event.target.value});
            elems.preLowcutFreqVal.textContent = event.target.value;
        });
    });
});

        </script>
        <style>
            table {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="error">Loading...</div>
        <div id="content" style="display: none">
            <div id="main">
                <input type="button" id="enable-input" value="Enable Input" />
            </div>
            <div id="bbba">
                <h2>Better audio for BigBlueButton</h2>
                <div>
                    <input autocomplete="off" type="checkbox" id="bbba-bypass" value="bbba-bypass" checked></input>
                    <label for="bbba-bypass">Bypass</label>
                </div>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Value</th>
                        <th>Controller</th>
                    </tr>
                    <tr>
                        <td>Strength</td>
                        <td><output id="bbba-strength-value"></output></td>
                        <td><input autocomplete="off" id="bbba-strength" type="range" value="50" min="0" max="100" /></td>
                    </tr>
                    <tr>
                        <td>Target</td>
                        <td><output id="bbba-target-value"></output></td>
                        <td><input autocomplete="off" id="bbba-target" type="range" value="-23" min="-60" max="0"></input></td>
                    </tr>
                    <tr>
                        <td>Thresh Offset</td>
                        <td><output id="bbba-thresh-offset-value"></output></td>
                        <td><input autocomplete="off" id="bbba-thresh-offset" type="range" value="6" min="0" max="40"></input></td>
                    </tr>
                    <tr>
                        <td>PreLowcut Freq</td>
                        <td><output id="bbba-preLowcut-freq-value"></output></td>
                        <td><input autocomplete="off" id="bbba-preLowcut-freq" type="range" value="80" min="1" max="400"></input></td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
